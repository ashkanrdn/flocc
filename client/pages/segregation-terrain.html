<div id="container"></div>
<script>
    const {
        Agent,
        Environment,
        Terrain,
        CanvasRenderer,
        utils,
        Vector,
        Rule
    } = flocc;

    /* ---------- PARAMETERS ---------- */

    const MOVE_THRESHOLD = 0.72;
    const width = 600;
    const height = 600;
    const PERCENT_EMPTY = 0.1;

    /* -------------------------------- */

    const container = document.getElementById("container");
    const environment = new Environment({ width, height });
    const renderer = new CanvasRenderer(environment, { width, height });
    renderer.mount(container);

    const terrain = new Terrain(width, height, {
        async: true
    });
    environment.use(terrain);

    const empty = { r: 255, g: 255, b: 255, a: 255 };
    const red = { r: 255, g: 0, b: 0, a: 255 };
    const blue = { r: 0, g: 0, b: 255, a: 255 };

    function setup() {
        terrain.init((x, y) => {
            if (Math.random() < PERCENT_EMPTY) return empty;
            return Math.random() > 0.5 ? red : blue;
        });
    }

    function exists(x, y) {
        return !areSame(terrain.sample(x, y), empty);
    }

    function areSame(p1, p2) {
        return p1.r === p2.r && p1.g === p2.g && p1.b === p2.b && p1.a === p2.a;
    }

    function findOpenSpace() {
        let space = null;
        do {
            space = { x: utils.random(0, width), y: utils.random(0, height) };
        } while (exists(space.x, space.y));
        return space;
    }

    function swap(x1, y1, x2, y2) {
        const p1 = terrain.sample(x1, y1);
        const p2 = terrain.sample(x2, y2);
        terrain.set(x2, y2, p1.r, p1.g, p1.b, p1.a);
        terrain.set(x1, y1, p2.r, p2.g, p2.b, p2.a);
    }

    let population = 0;

    terrain.rule = (x, y) => {
        const color = terrain.sample(x, y);
        if (areSame(color, empty)) return;
        population++;

        let neighbors = 0;
        let percentLike = 0;

        for (let dx = -1; dx <= 1; dx++) {
            for (let dy = -1; dy <= 1; dy++) {
                if (dx === 0 && dy === 0) continue;
                if (exists(x + dx, y + dy)) neighbors++;
                if (areSame(color, terrain.sample(x + dx, y + dy))) {
                    percentLike++;
                }
            }
        }
        if (neighbors === 0) return;
        percentLike /= neighbors;
        if (percentLike >= MOVE_THRESHOLD) return;

        const open = findOpenSpace();
        if (open) swap(x, y, open.x, open.y);
    };

    function render() {
        environment.tick();
        requestAnimationFrame(render);
    }

    setup();
    render();
</script>
