<div id="container"></div>
<div id="histogram"></div>
<script>
    const PERCENT_FULL = 0.57;
    const environment = new Environment({
        torus: true,
        width: 600,
        height: 600
    });
    const renderer = new CanvasRenderer(environment, {
        background: "#ccc",
        width: 600,
        height: 600
    });
    renderer.mount("#container");

    let tree;

    function setup() {
        // add agents here
        for (let i = 0; i < 600; i++) {
            const agent = new Agent();
            // agent.set("size", 1);
            agent.set({
                x: utils.random(0, 600),
                y: utils.random(0, 600)
            });
            environment.addAgent(agent);
        }
        tree = new KDTree(environment.getAgents(), 2);
    }

    class BBox {
        constructor(minX, minY, maxX, maxY) {
            this.minX = minX;
            this.minY = minY;
            this.maxX = maxX;
            this.maxY = maxY;
        }

        clone() {
            return new BBox(this.minX, this.minY, this.maxX, this.maxY);
        }
    }

    function draw(tree, color = "black") {
        const axis = tree.axis();
        renderer.context.beginPath();
        const dpr = window.devicePixelRatio;
        const median = tree.median * dpr;
        renderer.context.strokeStyle = color;
        if (axis === "x") {
            renderer.context.moveTo(median, tree.bbox.min.y * dpr);
            renderer.context.lineTo(median, tree.bbox.max.y * dpr);
        } else if (axis === "y") {
            renderer.context.moveTo(tree.bbox.min.x * dpr, median);
            renderer.context.lineTo(tree.bbox.max.x * dpr, median);
        }
        renderer.context.stroke();
        if (tree.left) draw(tree.left, "blue");
        if (tree.right) draw(tree.right, "red");
    }

    function run() {
        // window.requestAnimationFrame(run);

        let rando = utils.sample(environment.getAgents());
        while (rando.get("y") < 590 && rando.get("x") < 590) {
            rando = utils.sample(environment.getAgents());
        }
        rando.set("color", "red");
        rando.set("size", 5);

        tree.agentsWithinDistance(rando, 100).forEach(a => a.set("size", 3));

        environment.tick();

        draw(tree);

        // console.log("ticking");
        // setTimeout(run, 250);
    }

    setup();
    run();
</script>
